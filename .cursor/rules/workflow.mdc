---
alwaysApply: true
---
# InvoiceMe — Workflow Rules (Spec-Driven)

## Authority (Active Spec Version)

This repository uses Spec-Kit specs.

### Active Spec Pointer
- The active spec version is defined in: specs/ACTIVE_SPEC.txt
- You MUST read specs/ACTIVE_SPEC.txt at the start of every task.
- ALL implementation must align ONLY with the spec folder referenced by specs/ACTIVE_SPEC.txt.
- Do NOT implement from older spec folders unless explicitly instructed.

### If Unclear / Conflicts
- If the active spec conflicts internally or something is unclear: do NOT guess.
- Add an Open Question to: <ACTIVE_SPEC>/DECISIONS.md
  - Include: context, options, recommendation, reasoning.


## Multi-tenancy (MANDATORY)
- tenantId MUST be derived from Supabase Auth JWT claim `sub`.
- Every user-owned DB table MUST include tenantId.
- Every read/write query MUST filter by tenantId.
- No cross-tenant reads/writes under any circumstances.
- Any code touching DB must include automated checks or tests verifying tenant scoping.

## Domain Definition (MANDATORY)
- "Business" in UI means "Vendor/Supplier" on the invoice (where money was spent).
- Do not treat "Business" as a user workspace or the user's own company unless specs explicitly change this.

## PDF/OCR Pipeline Rules (MANDATORY)
- Supported uploads: image and PDF.
- PDF handling:
  1) If PDF has selectable text, extract text without OCR.
  2) Else convert pages to images and OCR.
  3) POC limit: OCR only first 2 pages max.
- OCR must use Tesseract with languages: heb+eng.
- Ollama is used ONLY to structure extracted OCR text into strict JSON (it does NOT do OCR).

## AI Insights Rules (MANDATORY)
- SQL/DB computes truth (totals, KPIs, trends).
- LLM (Ollama) only summarizes/explains based on computed facts.
- LLM output must never contradict SQL totals. If mismatch or uncertainty, mark as needsReview and surface warnings.

## Storage Rules (MANDATORY)
- Invoice files (PDF/images) must be stored outside the DB (local filesystem or object storage).
- DB stores metadata + artifacts (raw OCR text, raw LLM JSON, confidence, warnings, validation results).

## Scope Rules (MANDATORY)
- Export for POC is complete when CSV is generated and downloadable.
- Email/FTP integrations are OUT OF SCOPE unless specs explicitly include them.

## Implementation Order (MANDATORY)
1) Prisma schema + migrations per specs/DATA_MODEL.md
2) Auth + tenant guard per specs/API_CONTRACTS.md
3) Upload pipeline end-to-end per specs/PIPELINE.md
4) CRUD APIs (vendors/invoices/settings)
5) Analytics APIs
6) AI insights APIs
7) Flutter screens
8) Tests + RUNBOOK.md

## External Integrations - Must Use Latest Docs (MANDATORY)
When implementing or updating ANY external integration (Supabase, exchangeratesapi.io, Ollama, Tesseract, etc.):

1) DO NOT rely on memory or assumptions.
2) ALWAYS verify the latest official documentation (or latest SDK reference) for:
   - API endpoints / base URLs
   - authentication method (keys, JWT, OAuth)
   - env var names
   - SDK initialization
   - breaking changes / migration notes
   - deprecations and replacements
3) If documentation changed, update ALL of:
   - project code
   - README / docs
   - .env.example
   - integration helpers/services
4) If the latest docs are unclear or multiple approaches exist:
   - choose the recommended approach
   - explain reasoning inside code comments or specs
5) Every integration must include:
   - link(s) to the official docs used
   - last verification date (YYYY-MM-DD)
   - SDK/version used (if applicable)

## Integration Verification Requirement (STRICT)
For every external service integration, include a short "Docs Verified" section in the implementation notes (or PR notes) containing:
- Official docs URL(s)
- Verified on: YYYY-MM-DD
- SDK/version used

## Task Completion Definition (MANDATORY VALIDATION)

A task is NOT considered complete unless it is VALIDATED.

### Validation Requirements (must run)
For EVERY implemented task, you MUST do all of the following before claiming completion:

#### Frontend (Flutter)
1) `flutter analyze`
2) `flutter test` (if tests exist)
3) Build must succeed for at least one target:
   - `flutter run -d chrome` OR
   - `flutter build web` OR
   - `flutter build apk` (optional)

#### Backend (NestJS)
1) `npm run lint` (or equivalent)
2) `npm run build`
3) Unit tests if configured:
   - `npm test` / `pnpm test` / `yarn test`

#### Database/Prisma
1) `npx prisma validate`
2) If schema changed:
   - migration must run locally successfully
   - app must start and query DB without Prisma errors

### Error Policy (STRICT)
- If ANY of the above fails, you MUST fix it immediately.
- You MUST NOT leave TypeScript errors, Dart errors, analyzer warnings treated as errors, or runtime crashes.
- You MUST NOT mark the task complete until the validation passes.

### Reporting Format (MANDATORY)
After finishing each task, output:

1) ✅ Task ID + brief summary
2) Files changed (list)
3) Validation results:
   - Frontend: `flutter analyze` ✅/❌
   - Backend: `npm run build` ✅/❌
   - Prisma: `prisma validate` ✅/❌
4) Manual test steps performed and result

### No-Drift Rule
- Only implement what the active spec/tasks require.
- If requirements are unclear or conflicting, STOP and update <ACTIVE_SPEC>/DECISIONS.md.



If missing, the implementation is considered incomplete.
